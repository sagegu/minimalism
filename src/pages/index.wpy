<template>
  <view class="container">
    <view class="header">
       <view class="level-1"  @tap="gotoBooks">
          <text>{{ book }}  ğŸ”» </text>
        </view>

        <!-- æ‰“å¡ -->
        <view  class="pull-right share-everyday" >
            <button open-type="share" @tap="share" >åˆ†äº«æ‰“å¡</button>
        </view>

      <view class="level-2">
        <view class="fs32 today-expend">{{ currentTotal }}</view>
        <view class="fs13 amount-expend"> <text>{{ headerTitle }}</text> </view>
        <view class="overflow-hide" wx:if="{{ bookTypeId==1 }}">  
          <view class="pull-left fs13">{{ header.position_2_human_name }} {{ header.position_2_amount }} {{ header.position_3_human_name }} {{ header.position_3_amount }} 
          </view>
        </view> 
      </view>      

      <i-notice-bar icon="systemprompt" wx:if="{{ header.show_notice_bar }}">
        <navigator wx:if="{{ header.notice_bar_path }}" url="{{ header.notice_bar_path }}">
          <text>{{ header.notice_text }}</text>
        </navigator>
        <text wx:else>{{ header.notice_text }}</text>
      </i-notice-bar>
    </view>
    
<!--      <view class="zan-btns new-record">
      <navigator url="/pages/statements/create">
        <button class="zan-btn jz-btn btn-shadow">è®°ä¸€ç¬”</button>
      </navigator>
    </view> -->
    <view class="statement-list" wx-if="{{ list.length > 0 }}">
      <repeat for="{{ list }}" key="index" index="index" item="item">
        <StatementItem :statement.sync="item"></StatementItem>
      </repeat>
    </view>

    <view wx:if="{{ list.length == 0 }}">
      <empty :title.sync="emptyTitle"></empty>
    </view>
  </view>

<!-- è®°è´¦ -->
     <view class="column"> 
        <view >
          <text @tap="gotoCreate" class="text-category" >ç”Ÿæˆæµ·æŠ¥</text>
        </view>
        <view >
          <button open-type="share" @tap="createZero" class="selected-category">æ— æ¶ˆè´¹æ‰“å¡</button>
          <!-- <text wx:if="{{ !submiting }}" @tap="createZero" class="selected-category" >æ— æ¶ˆè´¹æ‰“å¡</text>
           <text wx:else class="selected-category">æ— æ¶ˆè´¹æ‰“å¡...</text> -->
        </view>
        <view >
          <text @tap="gotoCreate" class="text-category" >è®°è´¦</text>
        </view>
    </view>

  <!-- è¯·æ±‚æˆæƒ -->
      <view wx:if="{{ !userInfo }}">  
       <view class="auth-float">      
        <image src="../public/images/nimumallogo.png"></image>
  <!--       <button open-type="getPhoneNumber" bindgetphonenumber="getPhoneNumber">Get Phone</button>
   -->
        <button open-type="getUserInfo" bindgetuserinfo="getUserInfo">å¼€å¯æç®€æ˜Ÿçƒè´¦æœ¬</button>
      </view>
    </view>

  <!-- åˆ†äº« -->
    <!--   <view>  
       <view class="share-float">      
        <image src="../public/images/forwardbg.png"></image>
        <view >
          <text @tap="gotoCreate" class="text-category" >å¤ªæ£’äº†</text>
          <text @tap="gotoCreate" class="text-category" >é‚€è¯·å¥½å‹ä¸€èµ·è¾¾æˆç›®æ ‡</text>
        </view>
       </view>
    </view> -->

</template>

<script>
  import wepy from 'wepy'
  import wxRequest from '@/utils/wxRequest'
  import Session from '@/utils/session'
  import Empty from '@/components/empty'
  import StatementItem from '@/components/index/statement'
  import { getStore } from 'wepy-redux'
  import { asyncList } from '@/store/actions'
  import Tip from '@/utils/tip'
  import Util from '@/utils/util.js'
  export default class Index extends wepy.page {
    config = {
      navigationBarTitleText: 'æç®€æ˜Ÿçƒè®°è´¦',
      "usingComponents": {
        "i-notice-bar": "../public/iview/notice-bar/index"
      }
    }

    data = {
      book: 'æ—¥å¸¸è´¦æœ¬',
      bookTypeId: 1,
      emptyTitle: 'æœ¬å‘¨è¿˜æ²¡æœ‰å¼€å§‹è®°è´¦å“¦~',
      orderEmptyTitle: 'æ— é¢„è´­æ¸…å•ï¼Œç‚¹å‡»ä¸‹æ–¹æ·»åŠ ä¸€ç¬”å§',
     
      // list: [ {id: '1', description: 'ä»Šå¤©å¾ˆèƒ½èŠ±', category: 'åƒå–', asset: 'æ‹›å•†é“¶è¡Œ', timeStr:'06-24', money: '10.0'},
      //        {id: '1', description: 'é›ªé¡¶å’–å•¡', category: 'åƒå–', asset: 'æ‹›å•†é“¶è¡Œ', timeStr:'06-24', money: '10.0'}  ],
      list: [],
      header: { position_2_human_name: "æŒ‘æˆ˜é‡‘é¢ï¼š", position_2_amount: 1000, position_3_human_name:"ï¼›  ç»“ä½™ï¼š", position_3_amount: " " },

      headerTitle:  "å½“æœˆæ”¯å‡º",

      userInfo: true,
      currentTotal: '',
      submiting: false,
      currentPageIndex: 1,
      hasMoreData: true,
      isFirstOnShow: true,
    }

    components = {
      empty: Empty,
      orderEmpty: Empty,
      StatementItem
		}
  
    globalData = {
      user: {},
    }

    onShow () {
      this.hasMoreData = true
      this.currentPageIndex  = 1

      //ä¼šæ˜¾ç¤ºæˆæƒ
      if (Session.get('login_unauthorized') == 'true' ) {
         this.userInfo = true   
      } 
      
      if (Session.get('index_load_cache1')) {
        this.list = Session.get('index_load_cache1')
      }      

      // current total 
      if (Session.get('current_total_load_cache')) {
        var total = Session.get('current_total_load_cache')
        total = total - 0
        this.currentTotal = total.toFixed(1)

        let left = this.header.position_2_amount - this.currentTotal
        this.header.position_3_amount = left < 0 ? 0 : left.toFixed(1)

      }

      if ( this.isFirstOnShow ) {
        //getUserInfoçœ‹æ˜¯å¦éœ€è¦æˆæƒ 
        this.postUser()  
      }
      this.updateUI() 

      if (Session.get('access') != null) {
         this.token()
      } 
      this.isFirstOnShow = false
    }

    onPullDownRefresh() {
      this.hasMoreData = true
      this.currentPageIndex  = 1
      wx.setNavigationBarTitle({
        title: 'åˆ·æ–°ä¸­â€¦â€¦'
      })//åŠ¨æ€è®¾ç½®å½“å‰é¡µé¢çš„æ ‡é¢˜ã€‚
   
      wx.showNavigationBarLoading();//åœ¨å½“å‰é¡µé¢æ˜¾ç¤ºå¯¼èˆªæ¡åŠ è½½åŠ¨ç”»ã€‚
      this.getList()       
    }
    
    onShareAppMessage (e) {
      if (e.from === 'menu') {
        return {
          title: 'æç®€æ˜Ÿçƒè®°è´¦ï¼Œä¸“ä¸ºæç®€ä¸»ä¹‰è€…å‡†å¤‡çš„è®°è´¦æœ¬',
          path: '/pages/index',
          imageUrl: '../public/images/foward.jpeg',
          success(e) { },
          fail(e) { },
          complete() { }
        }
      }
    }
    
    onReachBottom () {
      this.getMoreList()
    }

    methods = {
      gotoCreate () {
        wx.navigateTo({ url: "/pages/statements/create" })
      },
      gotoChallenge () {
        //wx.navigateTo({ url: "/pages/asset" })
      },
      gotoBooks () {
        wx.navigateTo({ url: "/pages/asset" })
      },
      getUserInfo (res) {
        this.userInfo = true
        if(res.detail.userInfo) {
          // console.log('ç”¨æˆ·ç‚¹å‡»äº†æˆæƒæŒ‰é’®')

          if (this.userInfo) {
             this.postUser() 
          }
        }else {
          // console.log('ç”¨æˆ·ç‚¹å‡»äº†å–æ¶ˆæŒ‰é’®')
        }
      },
      getPhoneNumber () {
      },
      share() {
        this.onShareAppMessage(1)
      },
      async createZero () {
        var alreadyCreateZero = false
        const myDate = new Date()
        let today = myDate.getDate()
       for (var i = this.list.length - 1; i >= 0; i--) {
          let date = Util.convertStrToDate(this.list[i].created_at)
          let day = date.getDate()
          if (day == today) {
            if (this.list[i].notes == 'ä»Šæ—¥æ— æ¶ˆè´¹') {
               wx.showToast({
                title: 'ä»Šæ—¥æ— æ¶ˆè´¹, å¤ªæ£’äº†!',
                icon: 'none',
                duration: 5000
               })
               alreadyCreateZero = true              
            } 
            if (this.list[i].amount > 0) {
              wx.showToast({
                title: 'æ‚¨ä»Šæ—¥å·²ç»æœ‰æ¶ˆè´¹!',
                icon: 'none',
                duration: 3000
               })
               //alreadyCreateZero = true
               return
            }
         } 
       }
       if (alreadyCreateZero == true) {
        this.onShareAppMessage(1)
        return
       }
       if (this.submitting == true) {
        return
       }
       this.submiting = true

       var bookId = 1
       if (Session.get('current_book_id')) {
          bookId = Session.get('current_book_id')
       }

        wx.showToast({
                title: 'ä»Šæ—¥æ— æ¶ˆè´¹, å¤ªæ£’äº†!',
                icon: 'none',
                duration: 3000
               })

        const p = {'record_type': 6, 
                    'amount': 0,
                    'notes': 'ä»Šæ—¥æ— æ¶ˆè´¹'}
        const result = await wxRequest.Post('books/' + bookId + '/records/' , p)
                      
        if (result === undefined) {
          this.submiting = false
          await tip.confirm('ç”±äºç½‘ç»œåŸå› ï¼Œæ— æ³•åŒæ­¥è´¦å•åˆ°æœåŠ¡å™¨ï¼Œç°å·²ä¸´æ—¶ä¿å­˜åœ¨æœ¬åœ°ï¼Œä¸‹æ¬¡ç½‘ç»œæ­£å¸¸åç³»ç»Ÿå°†è‡ªåŠ¨åŒæ­¥åˆ°æœåŠ¡ç«¯', {}, 'ä¿å­˜å¤±è´¥')
          Session.pushFailStatement(params)
          return false
        }
        this.getList()
        this.submiting = false


       this.onShareAppMessage(1)
      }
    }

    updateUI() {
      var books = []
      if (Session.get('challenge_load_cache')) {
         books = Session.get('challenge_load_cache')
      }
      var bookId = 1
      if (Session.get('current_book_id') !== null) {
         bookId = Session.get('current_book_id')
      } 

      for (var i = books.length - 1; i >= 0; i--) { 
        if (books[i]['id'] == bookId) {
          this.book = books[i]['name']
          this.bookTypeId = books[i]['book_type_id']

          let current = books[i]['month_to_date_total']
          if (current != undefined) {
            this.currentTotal = current 
          }
          this.$apply() 

          return
        }
      }
    }

    // é¢„åŠ è½½ç”¨æˆ·
   async postUser() {  
    const wxLogin =  wepy.login().then((loginResponse) => {

        const wxLogin1 =  wepy.login().then((resp) => {
          //console.log('2login code record is ++++++++', resp)
        })
        wepy.getUserInfo().then((response) => {  
          this.globalData.user = response.userInfo
          Session.set('userInfo', response.userInfo)

          response.userInfo['js_code'] = loginResponse.code
 
          //console.log('getUserInfo ++++++++', response)

          Session.set('login_unauthorized', 'false')
          this.userInfo = true
          this.$apply() 
          //é‡æ–°ç™»å½•
          if (Session.get('access') == null) {
              Tip.loading('åŠ è½½ä¸­...')
              this.login()
          }
      }, (err) => {
          this.userInfo = false  
          this.$apply()
          Session.set('login_unauthorized', 'false')
      })
    }) 
  }

    async token() {//æ£€æŸ¥tokenæ˜¯å¦è¿‡æœŸ
      let access = Session.get('access')
      const result = await wxRequest.Post('token/verify/', { 'token' : access})
     if (result == undefined) {
        let refresh = Session.get('refresh')
        if (refresh == null) {

          this.login()

        } else {
          const refreshResult = await wxRequest.Post('token/refresh/', { 'refresh' : refresh})
          //ç”¨refreshæ¢å–æ–°çš„access
          if (refreshResult == undefined) {

             this.login() 
 
          } else {
            Session.set('access', refreshResult.access)
            this.getChanllengeList()
          }
             
         }
     } else {
        this.getChanllengeList()
     }
    }

   async login() {
      var city = this.globalData.user['city']
      var province = this.globalData.user['province']
      var country = this.globalData.user['country']
      var language = this.globalData.user['language']
      const data = await wxRequest.Post('simple-wechat-login/', {
                'js_code': this.globalData.user['js_code'],
                 'avatar_url': this.globalData.user['avatarUrl'],
                 'nick_name': this.globalData.user['nickName'],
                 'city': city,
                 'province': province, 
                 'country': country,
                 'gender': this.globalData.user['gender'],
                 'language': language})
      if (typeof data != 'undefined') {
        this.globalData.user = data

          Session.set('access', data.access)
          Session.set('refresh', data.refresh)
          
          //å…ˆè·å–booklist è¿˜æ²¡æœ‰é»˜è®¤é€‰ä¸­çš„book idï¼Œä¸ç”¨getlist
          this.getChanllengeList()
 
      } else {
         

        Tip.loaded()
      }
  }

    async getList() {    
      const store = getStore() 
      const result = await store.dispatch(asyncList())
      const res = store.getState().statement.statements   
      this.list = res.results  

      if (res.book['book_type_id'] === 2) {
        this.currentTotal = res.book['month_to_date_total'].toFixed(1)
        this.headerTitle = 'å½“æœˆæ”¯å‡º'
      }
      else {
        this.currentTotal = res.challenge['current_total'].toFixed(1)
        this.headerTitle = 'æ€»æ”¯å‡º'
        this.header.position_2_amount = res.challenge['target_amount']

        let left = this.header.position_2_amount - this.currentTotal
        this.header.position_3_amount = left < 0 ? 0 : left.toFixed(1)
      }
      // this.currentTotal = res.challenge['current_total']
      Session.set('index_load_cache1', res.results)

      Session.set('current_total_load_cache', this.currentTotal)
      this.$apply()

      Tip.loaded()

      wx.hideNavigationBarLoading();//éšè—å¯¼èˆªæ¡åŠ è½½åŠ¨ç”»ã€‚
   
      wx.stopPullDownRefresh();//åœæ­¢å½“å‰é¡µé¢ä¸‹æ‹‰åˆ·æ–°ã€‚
      
      wx.setNavigationBarTitle({
        title: 'æç®€æ˜Ÿçƒè®°è´¦'
      })//åŠ¨æ€è®¾ç½®å½“å‰é¡µé¢çš„æ ‡é¢˜ã€‚
    }

    async getMoreList() {

      if (this.hasMoreData == false) {
        return
      }
      this.currentPageIndex ++
      var bookId = 1
      if (Session.get('current_book_id')) {
          bookId = Session.get('current_book_id')
      }      
      const data = await wxRequest.Get('books/' + bookId + '/records/', {page: this.currentPageIndex })
      if (typeof data.results == 'undefined') {
        return
      }
      if (data.next == null ){
        //console.log('data.results.next == null - moredata:', this.hasMoreData)
        this.hasMoreData = false
      }

      for (var i = data.results.length - 1; i >= 0; i--) {
         this.list.push(data.results[i])
      }
      this.$apply()
    }

    async getChanllengeList() {  
      const data = await wxRequest.Get('users/self/books/' )
      if (data == undefined) {
         self.login()
      } else {
        //ç«‹åˆ»ä¿å­˜æ•°æ®ï¼Œè´¦æœ¬listï¼Œä¸‹é¢å¦‚æœæ˜¯åˆæ¬¡ä½¿ç”¨ï¼Œé»˜è®¤é€‰æ‹©ç¬¬ä¸€ä¸ª
        Session.set('challenge_load_cache', data.results)

        // ç¬¬ä¸€æ¬¡ç™»å½•ï¼Œåªæœ‰è‡ªå·±çš„è´¦æœ¬ï¼Œè¿˜æ²¡æœ‰session 
        let bookid = Session.get('current_book_id')
        if (bookid == null ) {
          var id = data.results[0]['id']
          Session.set('current_book_id', id)
          console.log('é‡æ–°ç™»å½•current_book_id ++++++++++++++++', id)
         } else {
          //å¦‚æœæœ¬åœ°æœ‰bookidï¼ŒéªŒè¯æ˜¯å¦åˆæ ¼ 
          let verified = false
          let book = data.results
          for (var i = book.length - 1; i >= 0; i--) {
             if (bookid == book[i].id) {
                verified = true
                break
              }
          }
          if (!verified) {
             var id = data.results[0]['id']
             Session.set('current_book_id', id)
          }
        }
        //get list
        this.getList()
      } 
      Tip.loaded() 
      this.updateUI()
   }

    computed = {
      showEmpty () {
        return this.list.length <= 0
      }
    }
  }
</script>
<style lang="scss" src="@/public/styles/index.scss"></style>
